name: Build FFmpeg (Monthly) and Release

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 1 * *'   # 00:00 UTC on the 1st of every month
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: 'FFmpeg ref (tag like n7.1, branch, or commit SHA). Leave empty for latest stable tag.'
        required: false
        default: ''

permissions:
  contents: write  # needed to create releases

jobs:
  resolve_ref:
    name: Resolve FFmpeg ref
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.resolve.outputs.ref }}
      tag: ${{ steps.resolve.outputs.tag }}
      date: ${{ steps.date.outputs.date }}
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Compute date stamp
        id: date
        run: echo "date=$(date -u +'%Y%m')" >> "$GITHUB_OUTPUT"

      - name: Resolve ref (latest stable tag if empty)
        id: resolve
        env:
          INPUT_REF: ${{ github.event.inputs.ffmpeg_ref }}
        run: |
          if [ -n "$INPUT_REF" ]; then
            echo "Using provided ref: $INPUT_REF"
            echo "ref=$INPUT_REF" >> "$GITHUB_OUTPUT"
            # If it's a tag starting with n, also set tag; else leave empty
            if echo "$INPUT_REF" | grep -Eq '^n[0-9]+(\.[0-9]+)*$'; then
              echo "tag=$INPUT_REF" >> "$GITHUB_OUTPUT"
            else
              echo "tag=" >> "$GITHUB_OUTPUT"
            fi
            exit 0
          fi

          echo "Fetching tags from FFmpeg..."
          # Get tags, pick the highest nX[.Y] style tag
          TAG=$(curl -fsSL "https://api.github.com/repos/FFmpeg/FFmpeg/tags?per_page=100" \
            | jq -r '.[].name' \
            | grep -E '^n[0-9]+(\.[0-9]+)*$' \
            | sort -Vr \
            | head -n1)

          if [ -z "$TAG" ]; then
            echo "Failed to resolve latest FFmpeg tag" >&2
            exit 1
          fi

          echo "ref=$TAG" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  build:
    name: Build (${{ matrix.os }})
    needs: resolve_ref
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    env:
      FFMPEG_REF: ${{ needs.resolve_ref.outputs.ref }}
      FFMPEG_TAG: ${{ needs.resolve_ref.outputs.tag }}
      DATE_STAMP: ${{ needs.resolve_ref.outputs.date }}

    steps:
      - name: Checkout repo (for README/workflow context)
        uses: actions/checkout@v4

      - name: Print ref
        shell: bash
        run: |
          echo "FFMPEG_REF=$FFMPEG_REF"
          echo "FFMPEG_TAG=$FFMPEG_TAG"
          echo "DATE_STAMP=$DATE_STAMP"

      # ---------- Linux ----------
      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm git pkg-config curl zip jq musl-tools file

      - name: Build FFmpeg (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euxo pipefail
          git clone https://github.com/FFmpeg/FFmpeg.git
          cd FFmpeg
          git checkout "$FFMPEG_REF"
          # Build fully static using musl
          export CC=musl-gcc
          ./configure \
            --prefix="$PWD/install" \
            --disable-debug \
            --disable-doc \
            --enable-static \
            --disable-shared \
            --extra-ldflags="-static"
          make -j"$(nproc)"
          make install

          mkdir -p package package/LICENSES
          # Flatten: place binaries at package root
          cp -v install/bin/ffmpeg install/bin/ffprobe package/
          # Diagnostics: sizes and deps
          (cd package && ls -lah > FILES.txt)
          (cd package && file ./ffmpeg ./ffprobe > FILE-TYPE.txt)
          (cd package && ldd ./ffmpeg > DEPS-ffmpeg.txt 2>&1 || true)
          (cd package && ldd ./ffprobe > DEPS-ffprobe.txt 2>&1 || true)
          # licenses
          cp -v COPYING.LGPLv2.1 LICENSE.md package/LICENSES/ 2>/dev/null || true
          cp -v COPYING.GPLv2 package/LICENSES/ 2>/dev/null || true
          cp -v LICENSE.md package/LICENSES/ 2>/dev/null || true

          jq -n \
            --arg ref "$FFMPEG_REF" \
            --arg tag "${FFMPEG_TAG:-}" \
            --arg os "$RUNNER_OS" \
            --arg arch "$(uname -m)" \
            --arg date "$DATE_STAMP" \
            '{ref:$ref, tag:$tag, os:$os, arch:$arch, date:$date, notes:"Built with built-in codecs only (no external libs)."}' \
            > package/BUILD-INFO.json

          # no zip; artifacts uploaded directly from package/

      # ---------- macOS ----------
      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install yasm nasm jq

      - name: Build FFmpeg (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          git clone https://github.com/FFmpeg/FFmpeg.git
          cd FFmpeg
          git checkout "$FFMPEG_REF"
          ./configure \
            --prefix="$PWD/install" \
            --disable-debug \
            --disable-doc \
            --enable-static \
            --disable-shared
          make -j"$(sysctl -n hw.logicalcpu)"
          make install

          mkdir -p package package/LICENSES
          # Flatten: place binaries at package root
          cp -v install/bin/ffmpeg install/bin/ffprobe package/
          # Diagnostics: sizes and deps
          (cd package && ls -lah > FILES.txt)
          (cd package && otool -L ./ffmpeg > DEPS-ffmpeg.txt 2>&1 || true)
          (cd package && otool -L ./ffprobe > DEPS-ffprobe.txt 2>&1 || true)
          # licenses
          cp -v COPYING.LGPLv2.1 LICENSE.md package/LICENSES/ 2>/dev/null || true
          cp -v COPYING.GPLv2 package/LICENSES/ 2>/dev/null || true
          cp -v LICENSE.md package/LICENSES/ 2>/dev/null || true

          jq -n \
            --arg ref "$FFMPEG_REF" \
            --arg tag "${FFMPEG_TAG:-}" \
            --arg os "$RUNNER_OS" \
            --arg arch "$(uname -m)" \
            --arg date "$DATE_STAMP" \
            '{ref:$ref, tag:$tag, os:$os, arch:$arch, date:$date, notes:"Shared build on macOS (static linking limited)."}' \
            > package/BUILD-INFO.json

          # no zip; artifacts uploaded directly from package/

      # ---------- Windows (MSYS2) ----------
      - name: Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            git
            zip
            nasm
            yasm
            mingw-w64-x86_64-toolchain

      - name: Build FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          git clone https://github.com/FFmpeg/FFmpeg.git
          cd FFmpeg
          git checkout "$FFMPEG_REF"
          ./configure \
            --prefix="$PWD/install" \
            --target-os=mingw32 \
            --arch=x86_64 \
            --disable-debug \
            --disable-doc \
            --enable-static \
            --disable-shared \
            --pkg-config-flags="--static" \
            --extra-ldflags="-static -static-libgcc -static-libstdc++"
          make -j"$(nproc)"
          make install

          mkdir -p package package/LICENSES
          # Flatten: place binaries at package root
          cp -v install/bin/ffmpeg.exe install/bin/ffprobe.exe package/
          # Diagnostics: sizes and deps (PE imports)
          (cd package && ls -lah > FILES.txt)
          (cd package && objdump -p ./ffmpeg.exe | grep -i 'DLL Name' > DEPS-ffmpeg.txt 2>&1 || true)
          (cd package && objdump -p ./ffprobe.exe | grep -i 'DLL Name' > DEPS-ffprobe.txt 2>&1 || true)
          # licenses
          cp -v COPYING.LGPLv2.1 LICENSE.md package/LICENSES/ || true
          cp -v COPYING.GPLv2 package/LICENSES/ || true
          cp -v LICENSE.md package/LICENSES/ || true

          printf '{"ref":"%s","tag":"%s","os":"%s","date":"%s","notes":"Static build for Windows (MSYS2)"}' \
            "$FFMPEG_REF" "${FFMPEG_TAG:-}" "$RUNNER_OS" "$DATE_STAMP" > package/BUILD-INFO.json
          # Add arch to BUILD-INFO.json for Windows
          ARCH=$(uname -m)
          jq --arg arch "$ARCH" '.arch = $arch' package/BUILD-INFO.json > package/BUILD-INFO.tmp && mv package/BUILD-INFO.tmp package/BUILD-INFO.json

          # no zip; artifacts uploaded directly from package/

      # Upload artifact (Linux)
      - name: Upload artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ env.FFMPEG_TAG != '' && env.FFMPEG_TAG || env.FFMPEG_REF }}-Linux
          path: |
            FFmpeg/package/ffmpeg
            FFmpeg/package/ffprobe
            FFmpeg/package/BUILD-INFO.json
            FFmpeg/package/FILES.txt
            FFmpeg/package/FILE-TYPE.txt
            FFmpeg/package/DEPS-ffmpeg.txt
            FFmpeg/package/DEPS-ffprobe.txt
            FFmpeg/package/LICENSES/
          if-no-files-found: error

      # Upload artifact (macOS)
      - name: Upload artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ env.FFMPEG_TAG != '' && env.FFMPEG_TAG || env.FFMPEG_REF }}-macOS
          path: |
            FFmpeg/package/ffmpeg
            FFmpeg/package/ffprobe
            FFmpeg/package/BUILD-INFO.json
            FFmpeg/package/FILES.txt
            FFmpeg/package/DEPS-ffmpeg.txt
            FFmpeg/package/DEPS-ffprobe.txt
            FFmpeg/package/LICENSES/
          if-no-files-found: error

      # Upload artifact (Windows)
      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ env.FFMPEG_TAG != '' && env.FFMPEG_TAG || env.FFMPEG_REF }}-Windows
          path: |
            FFmpeg/package/ffmpeg.exe
            FFmpeg/package/ffprobe.exe
            FFmpeg/package/BUILD-INFO.json
            FFmpeg/package/FILES.txt
            FFmpeg/package/DEPS-ffmpeg.txt
            FFmpeg/package/DEPS-ffprobe.txt
            FFmpeg/package/LICENSES/
          if-no-files-found: error

  release:
    name: Publish Release
    needs: [resolve_ref, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List artifacts
        run: |
          ls -la ./artifacts
          find ./artifacts -type f -maxdepth 2 -print

      - name: Prepare release files (rename per-OS)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release
          for d in artifacts/*; do
            [ -d "$d" ] || continue
            os=""
            case "$(basename "$d")" in
              *Linux*) os="linux" ;;
              *Windows*) os="windows" ;;
              *macOS*) os="macos" ;;
              *) os="" ;;
            esac
            [ -n "$os" ] || continue
            # Artifacts are now flat; files are directly in $d
            # binaries
            if [ -f "$d/ffmpeg.exe" ]; then
              cp -f "$d/ffmpeg.exe" "release/ffmpeg-$os.exe"
            elif [ -f "$d/ffmpeg" ]; then
              cp -f "$d/ffmpeg" "release/ffmpeg-$os"
            fi
            if [ -f "$d/ffprobe.exe" ]; then
              cp -f "$d/ffprobe.exe" "release/ffprobe-$os.exe"
            elif [ -f "$d/ffprobe" ]; then
              cp -f "$d/ffprobe" "release/ffprobe-$os"
            fi
            # metadata
            [ -f "$d/BUILD-INFO.json" ] && cp -f "$d/BUILD-INFO.json" "release/BUILD-INFO-$os.json" || true
            [ -f "$d/FILES.txt" ] && cp -f "$d/FILES.txt" "release/FILES-$os.txt" || true
            [ -f "$d/DEPS-ffmpeg.txt" ] && cp -f "$d/DEPS-ffmpeg.txt" "release/DEPS-ffmpeg-$os.txt" || true
            [ -f "$d/DEPS-ffprobe.txt" ] && cp -f "$d/DEPS-ffprobe.txt" "release/DEPS-ffprobe-$os.txt" || true
            [ -f "$d/FILE-TYPE.txt" ] && cp -f "$d/FILE-TYPE.txt" "release/FILE-TYPE-$os.txt" || true
            # licenses (prefix filenames with OS to avoid release asset name collisions)
            if [ -d "$d/LICENSES" ]; then
              for f in "$d"/LICENSES/*; do
                [ -f "$f" ] || continue
                base=$(basename "$f")
                cp -f "$f" "release/${os}-LICENSE-${base}"
              done
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ needs.resolve_ref.outputs.tag != '' && needs.resolve_ref.outputs.tag || needs.resolve_ref.outputs.ref }}-${{ needs.resolve_ref.outputs.date }}${{ github.event_name == 'push' && format('-%s', github.run_number) || '' }}
          name: FFmpeg ${{ needs.resolve_ref.outputs.tag != '' && needs.resolve_ref.outputs.tag || needs.resolve_ref.outputs.ref }} Build (${{ needs.resolve_ref.outputs.date }})
          body: |
            Automated monthly build of FFmpeg.

            Upstream ref: ${{ needs.resolve_ref.outputs.ref }}
            Upstream tag: ${{ needs.resolve_ref.outputs.tag }}
            Date: ${{ needs.resolve_ref.outputs.date }}

          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
